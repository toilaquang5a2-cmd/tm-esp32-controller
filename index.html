<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TM-ESP32 Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #webcam-container canvas { width: 100%; max-width: 400px; border-radius: 4px; } 
        .result-box { margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #e9e9e9; text-align: left;}
        .label-output { font-size: 1.2em; font-weight: bold; }
        .status-ready { color: green; }
        .status-error { color: red; }
        input[type="text"] { width: 90%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üöó TM-ESP32 Controller</h2>
        
        <label for="espIp">Nh·∫≠p IP ESP32:</label>
        <input type="text" id="espIp" value="192.168.0.125" placeholder="e.g. 192.168.1.100"> 
        <div id="status" class="result-box status-error">Tr·∫°ng th√°i: ƒêang t·∫£i m√¥ h√¨nh...</div>

        <div id="webcam-container"></div>
        <div class="result-box">
            <p>Nh·∫≠n di·ªán:</p>
            <div id="label-container" class="label-output">Ch·ªù kh·ªüi ƒë·ªông camera...</div>
            <p>G·ª≠i tr·∫°ng th√°i: <span id="send-status">Ch∆∞a g·ª≠i</span></p>
        </div>
    </div>

    <script type="text/javascript">
        // ---------------------------------------------------------
        // C·∫•u h√¨nh (ƒê√É C·∫¨P NH·∫¨T URL M√î H√åNH V√Ä GI·∫¢M NG∆Ø·ª†NG)
        // ---------------------------------------------------------
        const URL = "https://teachablemachine.withgoogle.com/models/F8iU3qaRp/"; // URL M√î H√åNH C≈® C·ª¶A B·∫†N
        const THRESHOLD = 0.60;       // Ng∆∞·ª°ng ƒë·ªô tin c·∫≠y ƒë∆∞·ª£c gi·∫£m xu·ªëng 60%
        const DEBOUNCE_TIME = 500;    
        
        // --- BI·∫æN TO√ÄN C·ª§C ---
        let model, webcam, maxPredictions;
        let lastSentLabel = "";
        let lastSentTime = 0;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
            } catch (error) {
                document.getElementById("status").innerHTML = "Tr·∫°ng th√°i: <span class='status-error'>L·ªói t·∫£i m√¥ h√¨nh. Ki·ªÉm tra URL TM ho·∫∑c k·∫øt n·ªëi m·∫°ng.</span>";
                console.error("L·ªói khi t·∫£i m√¥ h√¨nh TM:", error);
                return;
            }

            const flip = true; 
            webcam = new tmImage.Webcam(400, 400, flip); 
            
            try {
                await webcam.setup(); 
                await webcam.play();
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                window.requestAnimationFrame(loop);
                document.getElementById("status").innerHTML = "Tr·∫°ng th√°i: <span class='status-ready'>S·∫µn s√†ng!</span>";
            } catch (error) {
                document.getElementById("status").innerHTML = "Tr·∫°ng th√°i: <span class='status-error'>L·ªói kh·ªüi t·∫°o Camera. Vui l√≤ng c·∫•p quy·ªÅn s·ª≠ d·ª•ng camera.</span>";
                console.error("L·ªói khi kh·ªüi t·∫°o Webcam:", error);
            }
        }

        async function loop() {
            if (webcam && webcam.canvas) {
                webcam.update(); 
                await predict();
            }
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let currentLabel = "";
            let maxConfidence = 0;

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i];
                const label = classPrediction.className.toUpperCase();
                const confidence = parseFloat(classPrediction.probability);
                
                if (confidence > maxConfidence) {
                    maxConfidence = confidence;
                    currentLabel = label;
                }
            }

            document.getElementById("label-container").innerText = 
                `${currentLabel} (${(maxConfidence * 100).toFixed(1)}%)`;

            const currentTime = Date.now();
            
            if (maxConfidence >= THRESHOLD && 
                (currentLabel !== lastSentLabel || (currentTime - lastSentTime > DEBOUNCE_TIME))) 
            {
                await sendHttpRequest(currentLabel);
            }
        }

        async function sendHttpRequest(label) {
            const espIp = document.getElementById("espIp").value;
            let endpoint = "";
            
            if (label.includes("XANG")) {
                endpoint = "/gas";
            } else if (label.includes("DIEN")) {
                endpoint = "/electric";
            } else {
                return; 
            }

            const url = `http://${espIp}${endpoint}`;
            
            try {
                const response = await fetch(url);
                if (response.ok) {
                    document.getElementById("send-status").innerText = `ƒê√£ g·ª≠i th√†nh c√¥ng: ${endpoint}`;
                    lastSentLabel = label;
                    lastSentTime = Date.now(); 
                } else {
                    document.getElementById("send-status").innerText = `L·ªói g·ª≠i HTTP: ${response.status} (${endpoint})`;
                }
            } catch (error) {
                document.getElementById("send-status").innerText = `L·ªói k·∫øt n·ªëi ESP32. ƒê·∫£m b·∫£o IP ch√≠nh x√°c v√† ESP ƒëang ch·∫°y.`;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
